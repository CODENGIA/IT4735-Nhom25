<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Firebase Google Auth RTDB Test</title>
</head>

<body>
    <h2>Firebase Google Auth + RTDB</h2>

    <button id="login">Login with Google</button>
    <button id="write">Write to RTDB</button>
    <button id="read">Read from RTDB</button>
    <button id="pair">Pair Device</button>

    <pre id="log"></pre>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getDatabase,
            ref,
            set,
            get,
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        //CONFIG 
        const firebaseConfig = {
            apiKey: "AIzaSyB3rRXDoiSRQITjVAre7nrGKnqntQOR5DA",
            authDomain: "iot-theft-detection.firebaseapp.com",
            databaseURL: "https://iot-theft-detection-default-rtdb.firebaseio.com",
            projectId: "iot-theft-detection",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        const log = (msg) =>
            (document.getElementById("log").textContent += msg + "\n");

        let currentUser = null;

        document.getElementById("login").onclick = async () => {
            const result = await signInWithPopup(auth, provider);
            currentUser = result.user;
            log("âœ… Logged in as: " + currentUser.email);
            log("UID: " + currentUser.uid);
        };

        document.getElementById("write").onclick = async () => {
            if (!currentUser) return alert("Login first");

            await set(ref(db, `users/${currentUser.uid}/system_status`), {
                armed: true,
                updated_at: Date.now(),
            });

            log("âœï¸ Wrote system_status to RTDB");
        };

        document.getElementById("read").onclick = async () => {
            if (!currentUser) return alert("Login first");

            const snap = await get(
                ref(db, `users/${currentUser.uid}/system_status`)
            );

            log("ðŸ“¥ Read from RTDB:");
            log(JSON.stringify(snap.val(), null, 2));
        };

        document.getElementById("pair").onclick = async () => {
            if (!currentUser) return alert("Login first");

            const deviceId = prompt("Enter device ID");
            if (!deviceId) return;

            const token = await currentUser.getIdToken();

            const res = await fetch(
                "https://pairdevicetouser-cr5tgbkwbq-uc.a.run.app",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify({ deviceId }),
                }
            );

            const data = await res.json();
            log("ðŸ”— Pair result:");
            log(JSON.stringify(data, null, 2));
        };

    </script>
</body>

</html>